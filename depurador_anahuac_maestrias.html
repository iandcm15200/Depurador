<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Depurador - Anahuac Maestrías (UCLA)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; }
    label { display:block; margin-top:10px; }
    select, textarea, input[type=file], button { margin-top:6px; }
    table { border-collapse: collapse; margin-top:12px; width:100%; }
    th, td { border: 1px solid #ccc; padding:6px; text-align:left; font-size:13px; }
    .controls { margin-top:12px; }
    .small { font-size:12px; color:#555; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h2>Depurador - Anahuac Maestrías (UCLA)</h2>

  <label>Versión de depuración:
    <select id="versionSelect">
      <option value="anahuac" selected>anahuac maestrías</option>
      <option value="maeAlumno">maeAlumno</option>
    </select>
  </label>

  <label id="maestriaLabel">
    Seleccione maestría:
    <select id="maestriaSelect">
      <option value="ucla">ucla maestrías</option>
      <!-- Agrega aquí más maestrías si las necesitas -->
    </select>
  </label>

  <label>Subir archivo CSV / TSV:
    <input type="file" id="fileInput" accept=".csv,.txt,.tsv" />
  </label>

  <label>O pegar aquí los datos sin depurar (CSV/TSV) - encabezados incluidos:
    <textarea id="pasteArea" rows="8" style="width:100%;" placeholder="Pega aquí el contenido CSV/TSV..."></textarea>
  </label>

  <div class="controls">
    <button id="btnParse">Procesar y mostrar</button>
    <button id="btnCopy" disabled>Copiar todo (para pegar en Excel)</button>
    <button id="btnDownload" disabled>Descargar CSV</button>
    <span class="small" id="status"></span>
  </div>

  <div id="result">
    <table id="resultTable" class="hidden">
      <thead><tr id="theadRow"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- PapaParse (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  (function(){
    const versionSelect = document.getElementById('versionSelect');
    const maestriaLabel = document.getElementById('maestriaLabel');
    const maestriaSelect = document.getElementById('maestriaSelect');
    const fileInput = document.getElementById('fileInput');
    const pasteArea = document.getElementById('pasteArea');
    const btnParse = document.getElementById('btnParse');
    const btnCopy = document.getElementById('btnCopy');
    const btnDownload = document.getElementById('btnDownload');
    const status = document.getElementById('status');
    const resultTable = document.getElementById('resultTable');
    const theadRow = document.getElementById('theadRow');
    const tbody = document.getElementById('tbody');

    // Campos que quieres mantener (estándar)
    const TARGET_FIELDS = [
      {key:'alumno', label:'Alumno'},
      {key:'correo', label:'Correo'},
      {key:'identificacion', label:'Identificación Alumno'},
      {key:'nombre_pago', label:'Nombre Pago'}
    ];

    // Mapa de variantes de nombres de encabezado -> nombre "normalizado" (clave)
    const HEADER_MAP = {
      'alumno': 'alumno',
      'alum': 'alumno',
      'estudiante': 'alumno',

      'correo': 'correo',
      'email': 'correo',
      'e-mail': 'correo',

      'identificacion alumno': 'identificacion',
      'identificacion': 'identificacion',
      'identificación alumno': 'identificacion',
      'id alumno': 'identificacion',
      'identificacion_alumno': 'identificacion',

      'nombre pago': 'nombre_pago',
      'nombre_pago': 'nombre_pago',
      'nombre del pago': 'nombre_pago',
      'nombrepago': 'nombre_pago'
    };

    // Mostrar/ocultar el select de maestrías según versión
    function updateMaestriaVisibility() {
      if (versionSelect.value === 'anahuac' || versionSelect.value === 'maestrias') {
        maestriaLabel.classList.remove('hidden');
      } else {
        maestriaLabel.classList.add('hidden');
      }
    }
    updateMaestriaVisibility();
    versionSelect.addEventListener('change', updateMaestriaVisibility);

    // Detectar archivo y ponerlo en el textarea automáticamente
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      status.textContent = 'Cargando archivo...';
      const reader = new FileReader();
      reader.onload = function(ev) {
        pasteArea.value = ev.target.result;
        status.textContent = 'Archivo cargado en el área de texto. Presiona "Procesar y mostrar".';
      };
      reader.onerror = function() {
        status.textContent = 'Error leyendo el archivo.';
      };
      reader.readAsText(f, 'UTF-8');
    });

    btnParse.addEventListener('click', () => {
      const raw = pasteArea.value.trim();
      if (!raw) { status.textContent = 'No hay datos para procesar.'; return; }
      status.textContent = 'Procesando...';
      const config = {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false
      };
      if (raw.indexOf('\t') !== -1 || raw.indexOf('\t') !== -1) {
        config.delimiter = '\t';
      }
      const parsed = Papa.parse(raw, config);
      if (parsed.errors && parsed.errors.length) {
        console.warn('Parse errors', parsed.errors);
      }
      const rows = parsed.data;
      if (!rows || !rows.length) { status.textContent = 'No se encontraron filas después del parseo.'; return; }

      const headersRaw = Object.keys(rows[0]);
      const headerIndexMap = {};
      headersRaw.forEach(h => {
        const normalized = normalize(h);
        const mapped = HEADER_MAP[normalized] || null;
        headerIndexMap[h] = mapped;
      });

      const cleanRows = rows.map(r => {
        const out = {};
        TARGET_FIELDS.forEach(tf => out[tf.key] = '');
        for (const rawH in r) {
          const mappedKey = headerIndexMap[rawH];
          if (mappedKey) {
            out[mappedKey] = r[rawH];
          }
        }
        return out;
      });

      // Reglas por versión / maestría (puedes adaptar)
      if (versionSelect.value === 'anahuac') {
        // por defecto la lista de maestrías contiene ucla maestrías
        cleanRows.forEach(row => {
          row.alumno = (row.alumno || '').toString().trim();
          row.correo = (row.correo || '').toString().trim();
          row.identificacion = (row.identificacion || '').toString().trim();
          row.nombre_pago = (row.nombre_pago || '').toString().trim();
        });
      } else if (versionSelect.value === 'maeAlumno') {
        cleanRows.forEach(row => {
          row.alumno = (row.alumno || '').toString().trim();
          row.correo = (row.correo || '').toString().trim();
          row.identificacion = (row.identificacion || '').toString().trim();
          row.nombre_pago = (row.nombre_pago || '').toString().trim();
        });
      }

      renderTable(cleanRows);
      status.textContent = 'Listo. Puedes copiar o descargar el CSV.';
      btnCopy.disabled = false;
      btnDownload.disabled = false;
    });

    btnCopy.addEventListener('click', async () => {
      const csv = tableToCsv();
      try {
        await navigator.clipboard.writeText(csv);
        status.textContent = 'Datos copiados al portapapeles. Pega en Excel (Ctrl+V).';
      } catch (err) {
        const ta = document.createElement('textarea');
        ta.value = csv;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); status.textContent = 'Datos copiados al portapapeles (método alterno).'; }
        catch(e){ status.textContent = 'No se pudo copiar automáticamente. Descarga el CSV y ábrelo en Excel.'; }
        document.body.removeChild(ta);
      }
    });

    btnDownload.addEventListener('click', () => {
      const csv = tableToCsv();
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const filename = 'depurado_anahuac_ucla.csv';
      a.setAttribute('download', filename);
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      status.textContent = 'CSV descargado.';
    });

    function renderTable(rows) {
      resultTable.classList.remove('hidden');
      theadRow.innerHTML = '';
      TARGET_FIELDS.forEach(tf => {
        const th = document.createElement('th');
        th.textContent = tf.label;
        theadRow.appendChild(th);
      });
      tbody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        TARGET_FIELDS.forEach(tf => {
          const td = document.createElement('td');
          td.textContent = r[tf.key] || '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function tableToCsv() {
      const rows = [];
      rows.push(TARGET_FIELDS.map(tf => tf.label).join(','));
      const trs = tbody.querySelectorAll('tr');
      trs.forEach(tr => {
        const cells = Array.from(tr.children).map(td => {
          let v = td.textContent || '';
          if (v.indexOf('"') !== -1) v = v.replace(/"/g,'""');
          if (v.indexOf(',') !== -1 || v.indexOf('\n') !== -1) v = `"${v}"`;
          return v;
        });
        rows.push(cells.join(','));
      });
      return rows.join('\r\n');
    }

    function normalize(s) {
      if (s === null || s === undefined) return '';
      return s.toString().trim().toLowerCase()
        .replace(/\s+/g,' ')
        .replace(/[_\-\.]+/g,' ')
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

  })();
  </script>
</body>
</html>